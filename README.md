# Hive-Movie - Catalog & Ticketing Engine ğŸ¬

> A high-performance core backend service responsible for managing the movie catalog, physical cinema infrastructure,
> and a highly concurrent seat reservation engine built with **.NET 10** and **C# 14**.

Hive-Movie acts as the transactional heart of the cinema ecosystem. It handles complex physical seating layouts, registers new movies and showtimes, and utilizes custom byte-level engine logic combined with Optimistic Concurrency Control to guarantee that race conditions and double-bookings are impossible during high-traffic ticket sales.

---

### ğŸ”— Associated Repositories

* ğŸ‘‰ **[Hive-Identity (Auth & Users)](https://www.google.com/search?q=https://github.com/Naveen2070/Hive-Identity)**
* ğŸ‘‰ **[EventHive UI (Frontend)](https://github.com/Naveen2070/EventHive-UI)**
* ğŸ‘‰ **[Hive-Event (Core API)](https://github.com/Naveen2070/EventHive)**

---

## ğŸš€ Key Features

* **ğŸŸï¸ High-Concurrency Ticketing:** Utilizes database-level Optimistic Concurrency Control (`RowVersion`) and a custom
  `SeatMapEngine` to ensure atomic reservations and prevent double-booking.
* **ğŸ“­ Transactional Outbox Pattern:** Guarantees 100% reliable email notification delivery. Events are atomically saved
  to SQL Server in the same transaction as ticket creations, and a highly concurrent background worker (`READPAST`/
  `UPDLOCK` CTEs) safely dispatches them to RabbitMQ.
* **ğŸ” Zero-Trust S2S Security:** Communicates internally with the Spring Boot Identity Service using mathematically
  secure **HMAC-SHA256** signatures, implemented via `DelegatingHandler` and **Refit** typed clients.
* **âš¡ Idempotent Webhooks:** Payment confirmation endpoints (e.g., for Stripe/Razorpay) are immune to duplicate network
  requests, safely rejecting expired tickets while securely locking paid seats.
* **ğŸ’º Complex Auditorium Layouts:** Seamlessly stores custom seating topologies (disabled seats, wheelchair spots,
  pricing tiers) using EF Core JSON column mapping and dynamic cross-property validation.
* **ğŸ§¯ Standardized Error Handling:** Fully compliant with **RFC 7807**. A centralized `IExceptionHandler` catches all
  domain and concurrency errors, returning predictable, beautifully formatted `ProblemDetails` JSON payloads.
* **ğŸ“š Rich OpenAPI Documentation:** Utilizes .NET Document Transformers to automatically generate an industrial-grade *
  *Scalar UI** portal, fully annotated with expected responses, default payload examples, and JWT Bearer integration.

---

## ğŸ› ï¸ Tech Stack

* **Language:** C# 14
* **Framework:** .NET 10 (ASP.NET Core Web API)
* **Database:** SQL Server (EF Core with JSON mapping)
* **Message Broker:** RabbitMQ
* **HTTP Client:** Refit (Declarative REST)
* **Validation:** FluentValidation & Data Annotations
* **API Documentation:** OpenAPI (v3) / Scalar UI
* **Testing:** xUnit, Moq, & **Testcontainers** (Isolated Docker SQL Server instances)

---

## ğŸ—ï¸ Architecture

The project follows a clean, decoupled **Domain-Service** architecture. Business logic is strictly isolated from HTTP
routing, and robust background infrastructure handles asynchronous tasks:

```text
Hive_Movie
â”œâ”€â”€ Configuration     # Dependency Injection & OpenAPI Document Transformers
â”œâ”€â”€ Controllers       # RESTful API routing (/api/{resource})
â”œâ”€â”€ Data              # EF Core DbContext, Seeders, and Migrations
â”œâ”€â”€ DTOs              # Immutable Data Transfer Objects (Records)
â”œâ”€â”€ Engine            # High-performance business logic (SeatMapEngine)
â”œâ”€â”€ Infrastructure    # External communication (RabbitMQ, Security, Refit Clients)
â”œâ”€â”€ Middleware        # Pipeline interceptors (GlobalExceptionHandler)
â”œâ”€â”€ Models            # Rich Domain Entities (Movie, Ticket, OutboxMessage, etc.)
â”œâ”€â”€ Services          # Decoupled business logic and CRUD abstractions
â”œâ”€â”€ Validators        # FluentValidation rules for complex cross-property checks
â””â”€â”€ Workers           # IHostedServices (Outbox Dispatcher, Ticket Cleanup)
```

---

## ğŸ”’ Security Architecture: JWT Integration

Hive-Movie operates as a trusting resource server within the ecosystem. It does not issue tokens. Instead, it relies on the asymmetric/symmetric JWTs generated by the Kotlin **Hive-Identity** service.

* **Read Operations (`GET`):** Public for catalog browsing.
* **Ticketing Operations (`POST` `/reserve`):** Require a valid JWT Bearer token identifying the user.
* **Mutating Operations (`POST`, `PUT`, `DELETE`):** Require a valid JWT Bearer token containing the `ROLE_ORGANIZER` or
  `ROLE_SUPER_ADMIN` claims.

---

## âš™ï¸ Getting Started (How to Run)

### Prerequisites

* **.NET 8 SDK**
* **Docker & Docker Compose** (For SQL Server and RabbitMQ)

### 1. Clone the Repository

```bash
git clone https://github.com/Naveen2070/Hive-Movie.git
cd Hive-Movie
```

### 2. Run the Standalone Environment

To test the Movie API in isolation without spinning up the entire Spring Boot ecosystem, use the included standalone
compose file. This boots up a dedicated SQL Server and RabbitMQ container.

```bash
docker compose -f docker-compose.standalone.yml up -d
```

### 3. Run Migrations & Start Application

Use the Entity Framework Core CLI to apply the database schema, then start the application.

```bash
# Apply schema to SQL Server
dotnet ef database update

# Run the API
dotnet run
```

### 4. Access the Developer Portal

Navigate to `http://localhost:5001/scalar` (or the port defined in your console) to access the interactive **Scalar UI
**. Here you can explore the fully documented endpoints, view payload schemas, and test the API directly from your
browser.

---

## ğŸ”Œ API Endpoints

### ğŸ¬ Movies Catalog (`/api/movies`)

| Method   | Endpoint           | Description                          | Access            |
|:---------|:-------------------|:-------------------------------------|:------------------|
| `GET`    | `/api/movies`      | Get all active movies (Newest first) | Public            |
| `GET`    | `/api/movies/{id}` | Get movie details by ID              | Public            |
| `POST`   | `/api/movies`      | Register a new movie to the catalog  | Admin / Organizer |
| `PUT`    | `/api/movies/{id}` | Full update of a movie's details     | Admin / Organizer |
| `DELETE` | `/api/movies/{id}` | Soft-delete a movie from the catalog | Admin / Organizer |

### ğŸ¢ Cinemas Management (`/api/cinemas`)

| Method   | Endpoint                   | Description                       | Access            |
|:---------|:---------------------------|:----------------------------------|:------------------|
| `GET`    | `/api/cinemas`             | Get all physical cinema locations | Public            |
| `GET`    | `/api/cinemas/{id}`        | Get a specific cinema by ID       | Public            |
| `POST`   | `/api/cinemas`             | Register a new cinema location    | Admin / Organizer |
| `PATCH`  | `/api/cinemas/{id}/status` | Update cinema approval status     | **Super Admin**   |
| `PUT`    | `/api/cinemas/{id}`        | Update cinema details             | Admin / Organizer |
| `DELETE` | `/api/cinemas/{id}`        | Soft-delete a cinema location     | Admin / Organizer |

### ğŸ’º Auditoriums & Layouts (`/api/auditoriums`)

| Method   | Endpoint                       | Description                                    | Access            |
|:---------|:-------------------------------|:-----------------------------------------------|:------------------|
| `GET`    | `/api/auditoriums`             | Get all auditoriums across all locations       | Public            |
| `GET`    | `/api/auditoriums/cinema/{id}` | Get all screens for a specific physical cinema | Public            |
| `GET`    | `/api/auditoriums/{id}`        | Get auditorium details and JSON seating layout | Public            |
| `POST`   | `/api/auditoriums`             | Create a new room with layout validation       | Admin / Organizer |
| `PUT`    | `/api/auditoriums/{id}`        | Update room dimensions and seating layout      | Admin / Organizer |
| `DELETE` | `/api/auditoriums/{id}`        | Soft-delete an auditorium                      | Admin / Organizer |

### ğŸ•’ Showtimes (`/api/showtimes`)

| Method   | Endpoint                      | Description                               | Access            |
|:---------|:------------------------------|:------------------------------------------|:------------------|
| `GET`    | `/api/showtimes/{id}/seatmap` | Get real-time JSON seat availability grid | Public            |
| `POST`   | `/api/showtimes`              | Schedule a new movie showing              | Admin / Organizer |
| `PUT`    | `/api/showtimes/{id}`         | Update showtime start time or base price  | Admin / Organizer |
| `DELETE` | `/api/showtimes/{id}`         | Remove a scheduled showtime               | Admin / Organizer |

### ğŸŸï¸ Checkout & Ticketing (`/api/tickets`)

| Method | Endpoint                       | Description                                      | Access |
|:-------|:-------------------------------|:-------------------------------------------------|:-------|
| `POST` | `/api/tickets/reserve`         | Reserve coordinates & calculate total price      | User   |
| `GET`  | `/api/tickets/my-bookings`     | Retrieve all tickets for the logged-in user      | User   |
| `POST` | `/api/tickets/payment/success` | Webhook: Confirm payment & convert seats to sold | Public |
---

**Built with â¤ï¸ by Naveen**